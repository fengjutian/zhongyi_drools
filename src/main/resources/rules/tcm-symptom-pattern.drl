package rules

import com.zhongyi.droolspro.model.Symptom;
import com.zhongyi.droolspro.model.Pulse;
import com.zhongyi.droolspro.model.Tongue;
import com.zhongyi.droolspro.model.Diagnosis;
import org.slf4j.Logger;

global Logger log; // 全局日志记录器，用于记录规则命中信息

// 症状 → 辨证规则

// --------------------- 气虚 ---------------------
// 主规则：三项症状（乏力/气短/自汗）+ 舌淡 + 脉弱
// 与支持规则互斥（activation-group "qi-exclusive"），避免重复诊断同一证型
rule "Pattern_Qi_Deficiency"
    salience 100
    activation-group "qi-exclusive"
when
    s : Symptom(fatigue == true, shortBreath == true, spontaneousSweat == true)
    t : Tongue(color == "淡")
    p : Pulse(weak == true)
then
    log.info("命中：气虚（舌淡、脉弱）");
    insert(new Diagnosis(
        "气虚",
        "乏力、气短、自汗、舌淡、脉弱",
        0.85
    ));
end

// 支持规则：三项症状 + 脉弱；并以体征组合（舌淡或舌淡体征、薄白苔或弱脉）增强命中
// 与主规则互斥：只保留先触发的更高优先级规则结果
rule "Pattern_Qi_Deficiency_Support"
    salience 95
    activation-group "qi-exclusive"
when
    s : Symptom(fatigue == true, shortBreath == true, spontaneousSweat == true)
    t : Tongue()
    p : Pulse(weak == true)
    eval( (Boolean.TRUE.equals(s.getPaleTongue()) || "淡".equals(t.getColor()))
          && ("薄白".equals(t.getCoating()) || Boolean.TRUE.equals(s.getWeakPulse())) )
then
    log.info("命中：气虚（体征支持：薄白苔/舌淡/弱脉）");
    insert(new Diagnosis(
        "气虚",
        "乏力、气短、自汗，体征支持：薄白苔/舌淡/弱脉",
        0.88
    ));
end

// --------------------- 阴虚 ---------------------
// 盗汗、口干；舌红且有裂纹；脉细数
rule "Pattern_Yin_Deficiency"
    salience 90
when
    s : Symptom(nightSweats == true, dryMouth == true)
    t : Tongue(color == "红", cracks == true)
    p : Pulse(thin == true, rapid == true)
then
    insert(new Diagnosis(
        "阴虚",
        "盗汗、口干、舌红带裂纹、脉细数",
        0.88
    ));
end

// --------------------- 脾阳虚 ---------------------
// 泄泻、腹冷痛、纳呆；舌淡薄白；脉弱
rule "Pattern_Spleen_Yang_Deficiency"
    salience 85
when
    s : Symptom(diarrhea == true, abdominalColdPain == true, poorAppetite == true)
    t : Tongue(color == "淡", coating == "薄白")
    p : Pulse(weak == true)
then
    log.info("命中：脾阳虚（泄泻、腹冷痛、纳呆、舌淡薄白、脉弱）");
    insert(new Diagnosis(
        "脾阳虚",
        "泄泻、腹冷痛、纳呆、舌淡薄白、脉弱",
        0.86
    ));
end

// --------------------- 湿热 ---------------------
// 发热、黄痰；苔黄腻；脉滑数
rule "Pattern_Damp_Heat"
    salience 80
when
    s : Symptom(fever == true, yellowMucus == true)
    t : Tongue(coating == "黄腻")
    p : Pulse(slippery == true, rapid == true)
then
    log.info("命中：湿热（发热、黄痰、苔黄腻、脉滑数）");
    insert(new Diagnosis(
        "湿热",
        "发热、黄痰、舌苔黄腻、脉滑数",
        0.84
    ));
end

// --------------------- 寒湿 ---------------------
// 恶寒、泄泻；苔薄白；脉滑弱
rule "Pattern_Cold_Damp"
    salience 75
when
    s : Symptom(chills == true, diarrhea == true)
    t : Tongue(coating == "薄白")
    p : Pulse(slippery == true, weak == true)
then
    log.info("命中：寒湿（恶寒、泄泻、苔薄白、脉滑弱）");
    insert(new Diagnosis(
        "寒湿",
        "恶寒、泄泻、舌苔薄白、脉滑弱",
        0.82
    ));
end

// --------------------- 风寒感冒 ---------------------
// 恶寒、无汗、流清涕；苔薄白
rule "Pattern_Wind_Cold"
when
    s : Symptom(chills == true, noSweat == true, runnyNose == true)
    t : Tongue(coating == "薄白")
then
    insert(new Diagnosis(
        "风寒",
        "恶寒、无汗、流清涕、薄白苔",
        0.8
    ));
end

// --------------------- 风热感冒 ---------------------
// 发热、咽痛、黄痰；苔薄黄
rule "Pattern_Wind_Heat"
when
    s : Symptom(fever == true, soreThroat == true, yellowMucus == true)
    t : Tongue(coating == "薄黄")
then
    insert(new Diagnosis(
        "风热",
        "发热、咽痛、黄痰、薄黄苔",
        0.83
    ));
end
